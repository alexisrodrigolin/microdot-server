<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad 03 - Control de Temperatura</title>
    <link rel="stylesheet" href="/styles/base.css">
</head>
<body>

<header>
    <h1>Actividad 03 - Control de LEDs, NeoPixel y Temperatura</h1>
</header>

<main>
    <div class="main-wrapper">

        <h1 class="titulo-centro">Hola mundo</h1>

        <div class="layout">

            <!-- Columna izquierda -->
            <div class="left-col">
                <h2>Control de LEDs individuales</h2>

                <h3>LED 1</h3>
                <button onclick="ledControl(1,'on')">Encender</button>
                <button onclick="ledControl(1,'off')">Apagar</button>

                <h3>LED 2</h3>
                <button onclick="ledControl(2,'on')">Encender</button>
                <button onclick="ledControl(2,'off')">Apagar</button>

                <h3>LED 3</h3>
                <button onclick="ledControl(3,'on')">Encender</button>
                <button onclick="ledControl(3,'off')">Apagar</button>
            </div>

            <!-- Columna derecha -->
            <div class="right-col">
                <h2>Color de la tira WS2812B</h2>

                <label for="color-select">Elegir color:</label>
                <select id="color-select" onchange="sendColor()">
                    <option value="255,0,0">Rojo</option>
                    <option value="0,255,0">Verde</option>
                    <option value="0,0,255">Azul</option>
                    <option value="255,255,0">Amarillo</option>
                    <option value="0,255,255">Cian</option>
                    <option value="255,0,255">Magenta</option>
                    <option value="255,255,255">Blanco</option>
                    <option value="0,0,0">Apagar</option>
                </select>

                <p>Color actual: <span id="color-display">---</span></p>

                <!-- Caja de temperatura a la derecha -->
                <div class="temp-container">
                    <h2>Control de Temperatura</h2>

                    <!-- Slider de Setpoint -->
                    <label for="tempSlider">
                        Temperatura deseada (setpoint):
                        <span id="tempSetValue">15°C</span>
                    </label>
                    <input type="range" id="tempSlider" min="0" max="30" value="15">

                    <!-- Temperatura real -->
                    <p>Temperatura actual del sensor:
                        <strong id="tempReal">---</strong>
                    </p>

                    <!-- Estado del buzzer -->
                    <p>Estado del buzzer:
                        <strong id="buzzerState">---</strong>
                    </p>
                </div>
            </div>

        </div>
    </div>
</main>

<footer>
    <p>Representación Frontal y Visual de Datos</p>
    <p>Computadoras de Aeronaves</p>
    <p>Alumnos Bianco Tomás y Lin Rodrigo</p>
    <p>Prof. Carlassara Fabrizio</p>
    <p id="fecha"></p>
</footer>

<script>
/* ---------------- LEDS: ahora SÍ hablan con el backend ---------------- */
function ledControl(n, state) {
    fetch(`/led/${n}/${state}`)
        .then(resp => resp.text())
        .then(txt => console.log(`LED ${n} -> ${state}:`, txt))
        .catch(err => console.error('Error LED:', err));
}

/* ---------------- NEOPIXEL: enviar color al backend ---------------- */
function sendColor() {
    const value = document.getElementById("color-select").value;
    const [r, g, b] = value.split(",");

    document.getElementById("color-display").textContent = `rgb(${r}, ${g}, ${b})`;

    fetch(`/ws2818b/color?r=${r}&g=${g}&b=${b}`)
        .then(resp => resp.text())
        .then(txt => console.log('Color NeoPixel OK:', txt))
        .catch(err => console.error('Error NeoPixel:', err));
}

/* ---------------- TEMPERATURA: slider + requests periódicos ---------------- */
const slider = document.getElementById("tempSlider");
const setVal = document.getElementById("tempSetValue");
const tempReal = document.getElementById("tempReal");
const buzzerState = document.getElementById("buzzerState");

// Mostrar valor de setpoint mientras se mueve el slider
slider.oninput = () => {
    setVal.textContent = slider.value + "°C";
};

// Al SOLTAR el slider, enviar al servidor
slider.onchange = () => {
    console.log("Nuevo setpoint:", slider.value + "°C");
    fetch(`/setpoint?value=${slider.value}`)
        .then(resp => resp.text())
        .then(text => {
            console.log("Setpoint en servidor:", text);
        })
        .catch(err => console.error("Error setpoint:", err));
};

// Función para pedir periódicamente la temperatura y estado del buzzer
function actualizarStatus() {
    fetch('/status')
        .then(resp => resp.json())
        .then(data => {
            if (data.temp === null) {
                tempReal.textContent = "Sin sensor";
            } else {
                tempReal.textContent = data.temp.toFixed(1) + "°C";
            }
            buzzerState.textContent = data.buzzer ? "ACTIVADO" : "APAGADO";
        })
        .catch(err => {
            console.error("Error status:", err);
            tempReal.textContent = "---";
            buzzerState.textContent = "Error";
        });
}

// Llamar una vez al cargar y luego cada 2 segundos
actualizarStatus();
setInterval(actualizarStatus, 2000);

/* ---------------- Fecha en el footer ---------------- */
const fecha = document.getElementById("fecha");
const hoy = new Date();
fecha.textContent = hoy.toLocaleDateString();
</script>

</body>
</html>